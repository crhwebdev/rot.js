var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){c!=Array.prototype&&c!=Object.prototype&&(c[a]=b.value)};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(c,a,b,d){if(a){b=$jscomp.global;c=c.split(".");for(d=0;d<c.length-1;d++){var e=c[d];e in b||(b[e]={});b=b[e]}c=c[c.length-1];d=b[c];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(b,c,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.fill",function(c){return c?c:function(a,b,d){var e=this.length||0;0>b&&(b=Math.max(0,e+b));if(null==d||d>e)d=e;d=Number(d);0>d&&(d=Math.max(0,e+d));for(b=Number(b||0);b<d;b++)this[b]=a;return this}},"es6","es3");
$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var c=0;return function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+c++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.iterator;c||(c=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[c]&&$jscomp.defineProperty(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(c){var a=0;return $jscomp.iteratorPrototype(function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(c){$jscomp.initSymbolIterator();c={next:c};c[$jscomp.global.Symbol.iterator]=function(){return this};return c};$jscomp.iteratorFromArray=function(c,a){$jscomp.initSymbolIterator();c instanceof String&&(c+="");var b=0,d={next:function(){if(b<c.length){var e=b++;return{value:a(e,c[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill("Array.prototype.keys",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
(function(c,a){"function"===typeof define&&define.amd?define([],a):"object"===typeof exports?module.exports=a():c.ROT=a()})(this,function(){var c={isSupported:function(){return!(!document.createElement("canvas").getContext||!Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,
VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,
VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,
VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,
VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95,Text:{RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(a,b){var d={width:0,height:1};a=this.tokenize(a,b);for(var e=b=0;e<a.length;e++){var f=a[e];switch(f.type){case this.TYPE_TEXT:b+=
f.value.length;break;case this.TYPE_NEWLINE:d.height++,d.width=Math.max(d.width,b),b=0}}d.width=Math.max(d.width,b);return d},tokenize:function(a,b){var d=[],e=0;a.replace(this.RE_COLORS,function(b,f,l,m){var g=a.substring(e,m);g.length&&d.push({type:c.Text.TYPE_TEXT,value:g});d.push({type:"c"==f?c.Text.TYPE_FG:c.Text.TYPE_BG,value:l.trim()});e=m+b.length;return""});var f=a.substring(e);f.length&&d.push({type:c.Text.TYPE_TEXT,value:f});return this._breakLines(d,b)},_breakLines:function(a,b){b||(b=
Infinity);for(var d=0,e=0,f=-1;d<a.length;){var g=a[d];g.type==c.Text.TYPE_NEWLINE&&(e=0,f=-1);if(g.type!=c.Text.TYPE_TEXT)d++;else{for(;0==e&&" "==g.value.charAt(0);)g.value=g.value.substring(1);var h=g.value.indexOf("\n");if(-1!=h){g.value=this._breakInsideToken(a,d,h,!0);for(h=g.value.split("");h.length&&" "==h[h.length-1];)h.pop();g.value=h.join("")}if(g.value.length){if(e+g.value.length>b){for(h=-1;;){var l=g.value.indexOf(" ",h+1);if(-1==l)break;if(e+l>b)break;h=l}-1!=h?g.value=this._breakInsideToken(a,
d,h,!0):-1!=f?(g=a[f],d=g.value.lastIndexOf(" "),g.value=this._breakInsideToken(a,f,d,!0),d=f):g.value=this._breakInsideToken(a,d,b-e,!1)}else e+=g.value.length,-1!=g.value.indexOf(" ")&&(f=d);d++}else a.splice(d,1)}}a.push({type:c.Text.TYPE_NEWLINE});b=null;for(d=0;d<a.length;d++)switch(g=a[d],g.type){case c.Text.TYPE_TEXT:b=g;break;case c.Text.TYPE_NEWLINE:if(b){for(h=b.value.split("");h.length&&" "==h[h.length-1];)h.pop();b.value=h.join("")}b=null}a.pop();return a},_breakInsideToken:function(a,
b,d,e){var f={type:c.Text.TYPE_NEWLINE};e={type:c.Text.TYPE_TEXT,value:a[b].value.substring(d+(e?1:0))};a.splice(b+1,0,f,e);return a[b].value.substring(0,d)}}};Array.prototype.random=Array.prototype.random||function(){return this.length?this[Math.floor(c.RNG.getUniform()*this.length)]:null};Array.prototype.randomize=Array.prototype.randomize||function(){for(var a=[],b=this.slice();b.length;){var d=b.indexOf(b.random());a.push(b.splice(d,1)[0])}return a};Number.prototype.mod=Number.prototype.mod||
function(a){return(this%a+a)%a};String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)};String.prototype.lpad=String.prototype.lpad||function(a,b){a=a||"0";b=b||2;for(var d="";d.length<b-this.length;)d+=a;d=d.substring(0,b-this.length);return d+this};String.prototype.rpad=String.prototype.rpad||function(a,b){a=a||"0";b=b||2;for(var d="";d.length<b-this.length;)d+=a;d=d.substring(0,b-this.length);return this+d};String.format=String.format||
function(a){var b=String.format.map,d=Array.prototype.slice.call(arguments,1);return a.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,function(e,f,c,h){if("%"==a.charAt(h-1))return e.substring(1);if(!d.length)return e;c=(f||c).split(",");f=c.shift();h=b[f.toLowerCase()];if(!h)return e;e=d.shift();e=e[h].apply(e,c);f=f.charAt(0);f!=f.toLowerCase()&&(e=e.capitalize());return e})};String.format.map=String.format.map||{s:"toString"};String.prototype.format=String.prototype.format||function(){var a=Array.prototype.slice.call(arguments);
a.unshift(this);return String.format.apply(String,a)};Object.create||(Object.create=function(a){var b=function(){};b.prototype=a;return new b});Function.prototype.extend=Function.prototype.extend||function(a){this.prototype=Object.create(a.prototype);this.prototype.constructor=this;return this};"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||
function(a){return setTimeout(function(){a(Date.now())},1E3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(a){return clearTimeout(a)});c.Display=function(a){this._context=document.createElement("canvas").getContext("2d");this._data={};this._dirty=!1;this._options={};this._backend=null;var b={width:c.DEFAULT_WIDTH,height:c.DEFAULT_HEIGHT,transpose:!1,
layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1,termColor:"xterm"},d;for(d in a)b[d]=a[d];this.setOptions(b);this.DEBUG=this.DEBUG.bind(this);this._tick=this._tick.bind(this);requestAnimationFrame(this._tick)};c.Display.prototype.DEBUG=function(a,b,d){var e=[this._options.bg,this._options.fg];this.draw(a,b,null,null,e[d%e.length])};c.Display.prototype.clear=function(){this._data=
{};this._dirty=!0};c.Display.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b];if(a.width||a.height||a.fontSize||a.fontFamily||a.spacing||a.layout)a.layout&&(this._backend=new (c.Display[a.layout.capitalize()])(this._context)),a=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily,this._context.font=a,this._backend.compute(this._options),this._context.font=a,this._context.textAlign="center",this._context.textBaseline="middle",
this._dirty=!0;return this};c.Display.prototype.getOptions=function(){return this._options};c.Display.prototype.getContainer=function(){return this._context.canvas};c.Display.prototype.computeSize=function(a,b){return this._backend.computeSize(a,b,this._options)};c.Display.prototype.computeFontSize=function(a,b){return this._backend.computeFontSize(a,b,this._options)};c.Display.prototype.eventToPosition=function(a){if(a.touches){var b=a.touches[0].clientX;a=a.touches[0].clientY}else b=a.clientX,a=
a.clientY;var d=this._context.canvas.getBoundingClientRect();b-=d.left;a-=d.top;b*=this._context.canvas.width/this._context.canvas.clientWidth;a*=this._context.canvas.height/this._context.canvas.clientHeight;return 0>b||0>a||b>=this._context.canvas.width||a>=this._context.canvas.height?[-1,-1]:this._backend.eventToPosition(b,a)};c.Display.prototype.draw=function(a,b,d,e,f){e||(e=this._options.fg);f||(f=this._options.bg);this._data[a+","+b]=[a,b,d,e,f];!0!==this._dirty&&(this._dirty||(this._dirty=
{}),this._dirty[a+","+b]=!0)};c.Display.prototype.drawText=function(a,b,d,e){var f=null,g=null,h=a,l=1;e||(e=this._options.width-a);for(d=c.Text.tokenize(d,e);d.length;)switch(e=d.shift(),e.type){case c.Text.TYPE_TEXT:for(var m,n=!1,p,q=!1,r=0;r<e.value.length;r++){m=e.value.charCodeAt(r);var t=e.value.charAt(r);p=65280<m&&65377>m||65500<m&&65512>m||65518<m;m=32==t.charCodeAt(0)||12288==t.charCodeAt(0);!q||p||m||h++;p&&!n&&h++;this.draw(h++,b,t,f,g);n=m;q=p}break;case c.Text.TYPE_FG:f=e.value||null;
break;case c.Text.TYPE_BG:g=e.value||null;break;case c.Text.TYPE_NEWLINE:h=a,b++,l++}return l};c.Display.prototype._tick=function(){requestAnimationFrame(this._tick);if(this._dirty){if(!0===this._dirty){this._context.fillStyle=this._options.bg;this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var a in this._data)this._draw(a,!1)}else for(var b in this._dirty)this._draw(b,!0);this._dirty=!1}};c.Display.prototype._draw=function(a,b){a=this._data[a];a[4]!=this._options.bg&&
(b=!0);this._backend.draw(a,b)};c.Display.Backend=function(a){this._context=a};c.Display.Backend.prototype.compute=function(a){};c.Display.Backend.prototype.draw=function(a,b){};c.Display.Backend.prototype.computeSize=function(a,b){};c.Display.Backend.prototype.computeFontSize=function(a,b){};c.Display.Backend.prototype.eventToPosition=function(a,b){};c.Display.Rect=function(a){c.Display.Backend.call(this,a);this._spacingY=this._spacingX=0;this._canvasCache={};this._options={}};c.Display.Rect.extend(c.Display.Backend);
c.Display.Rect.cache=!1;c.Display.Rect.prototype.compute=function(a){this._canvasCache={};this._options=a;var b=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(a.spacing*b);this._spacingY=Math.ceil(a.spacing*a.fontSize);this._options.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY));this._context.canvas.width=a.width*this._spacingX;this._context.canvas.height=a.height*this._spacingY};c.Display.Rect.prototype.draw=function(a,b){this.constructor.cache?
this._drawWithCache(a,b):this._drawNoCache(a,b)};c.Display.Rect.prototype._drawWithCache=function(a,b){b=a[0];var d=a[1],e=a[2],f=a[3],c=a[4];a=""+e+f+c;if(a in this._canvasCache)var h=this._canvasCache[a];else{var l=this._options.border;h=document.createElement("canvas");var m=h.getContext("2d");h.width=this._spacingX;h.height=this._spacingY;m.fillStyle=c;m.fillRect(l,l,h.width-l,h.height-l);if(e)for(m.fillStyle=f,m.font=this._context.font,m.textAlign="center",m.textBaseline="middle",e=[].concat(e),
f=0;f<e.length;f++)m.fillText(e[f],this._spacingX/2,Math.ceil(this._spacingY/2));this._canvasCache[a]=h}this._context.drawImage(h,b*this._spacingX,d*this._spacingY)};c.Display.Rect.prototype._drawNoCache=function(a,b){var d=a[0],e=a[1],f=a[2],c=a[3];a=a[4];b&&(b=this._options.border,this._context.fillStyle=a,this._context.fillRect(d*this._spacingX+b,e*this._spacingY+b,this._spacingX-b,this._spacingY-b));if(f)for(this._context.fillStyle=c,f=[].concat(f),c=0;c<f.length;c++)this._context.fillText(f[c],
(d+.5)*this._spacingX,Math.ceil((e+.5)*this._spacingY))};c.Display.Rect.prototype.computeSize=function(a,b){return[Math.floor(a/this._spacingX),Math.floor(b/this._spacingY)]};c.Display.Rect.prototype.computeFontSize=function(a,b){a=Math.floor(a/this._options.width);b=Math.floor(b/this._options.height);var d=this._context.font;this._context.font="100px "+this._options.fontFamily;var e=Math.ceil(this._context.measureText("W").width);this._context.font=d;a=e/100*b/a;1<a&&(b=Math.floor(b/a));return Math.floor(b/
this._options.spacing)};c.Display.Rect.prototype.eventToPosition=function(a,b){return[Math.floor(a/this._spacingX),Math.floor(b/this._spacingY)]};c.Display.Hex=function(a){c.Display.Backend.call(this,a);this._hexSize=this._spacingY=this._spacingX=0;this._options={}};c.Display.Hex.extend(c.Display.Backend);c.Display.Hex.prototype.compute=function(a){this._options=a;var b=Math.ceil(this._context.measureText("W").width);this._hexSize=Math.floor(a.spacing*(a.fontSize+b/Math.sqrt(3))/2);this._spacingX=
this._hexSize*Math.sqrt(3)/2;this._spacingY=1.5*this._hexSize;if(a.transpose){b="height";var d="width"}else b="width",d="height";this._context.canvas[b]=Math.ceil((a.width+1)*this._spacingX);this._context.canvas[d]=Math.ceil((a.height-1)*this._spacingY+2*this._hexSize)};c.Display.Hex.prototype.draw=function(a,b){var d=a[2],e=a[3],f=a[4];a=[(a[0]+1)*this._spacingX,a[1]*this._spacingY+this._hexSize];this._options.transpose&&a.reverse();b&&(this._context.fillStyle=f,this._fill(a[0],a[1]));if(d)for(this._context.fillStyle=
e,b=[].concat(d),d=0;d<b.length;d++)this._context.fillText(b[d],a[0],Math.ceil(a[1]))};c.Display.Hex.prototype.computeSize=function(a,b){this._options.transpose&&(a+=b,b=a-b,a-=b);return[Math.floor(a/this._spacingX)-1,Math.floor((b-2*this._hexSize)/this._spacingY+1)]};c.Display.Hex.prototype.computeFontSize=function(a,b){this._options.transpose&&(a+=b,b=a-b,a-=b);a=Math.min(2*a/((this._options.width+1)*Math.sqrt(3))-1,b/(2+1.5*(this._options.height-1)));b=this._context.font;this._context.font="100px "+
this._options.fontFamily;var d=Math.ceil(this._context.measureText("W").width);this._context.font=b;a=Math.floor(a)+1;return Math.ceil(2*a/(this._options.spacing*(1+d/100/Math.sqrt(3))))-1};c.Display.Hex.prototype.eventToPosition=function(a,b){if(this._options.transpose){a+=b;b=a-b;a-=b;var d=this._context.canvas.width}else d=this._context.canvas.height;b=Math.floor(b/(d/this._options.height));b.mod(2)?(a-=this._spacingX,a=1+2*Math.floor(a/(2*this._spacingX))):a=2*Math.floor(a/(2*this._spacingX));
return[a,b]};c.Display.Hex.prototype._fill=function(a,b){var d=this._hexSize,e=this._options.border;this._context.beginPath();this._options.transpose?(this._context.moveTo(a-d+e,b),this._context.lineTo(a-d/2+e,b+this._spacingX-e),this._context.lineTo(a+d/2-e,b+this._spacingX-e),this._context.lineTo(a+d-e,b),this._context.lineTo(a+d/2-e,b-this._spacingX+e),this._context.lineTo(a-d/2+e,b-this._spacingX+e),this._context.lineTo(a-d+e,b)):(this._context.moveTo(a,b-d+e),this._context.lineTo(a+this._spacingX-
e,b-d/2+e),this._context.lineTo(a+this._spacingX-e,b+d/2-e),this._context.lineTo(a,b+d-e),this._context.lineTo(a-this._spacingX+e,b+d/2-e),this._context.lineTo(a-this._spacingX+e,b-d/2+e),this._context.lineTo(a,b-d+e));this._context.fill()};c.Display.Tile=function(a){c.Display.Rect.call(this,a);this._options={};this._colorCanvas=document.createElement("canvas")};c.Display.Tile.extend(c.Display.Rect);c.Display.Tile.prototype.compute=function(a){this._options=a;this._context.canvas.width=a.width*a.tileWidth;
this._context.canvas.height=a.height*a.tileHeight;this._colorCanvas.width=a.tileWidth;this._colorCanvas.height=a.tileHeight};c.Display.Tile.prototype.draw=function(a,b){var d=a[0],e=a[1],f=a[2],c=a[3];a=a[4];var h=this._options.tileWidth,l=this._options.tileHeight;b&&(this._options.tileColorize?this._context.clearRect(d*h,e*l,h,l):(this._context.fillStyle=a,this._context.fillRect(d*h,e*l,h,l)));if(f)for(b=[].concat(f),f=0;f<b.length;f++){var m=this._options.tileMap[b[f]];if(!m)throw Error("Char '"+
b[f]+"' not found in tileMap");if(this._options.tileColorize){var n=this._colorCanvas,p=n.getContext("2d");p.clearRect(0,0,h,l);p.drawImage(this._options.tileSet,m[0],m[1],h,l,0,0,h,l);"transparent"!=c&&(p.fillStyle=c,p.globalCompositeOperation="source-atop",p.fillRect(0,0,h,l));"transparent"!=a&&(p.fillStyle=a,p.globalCompositeOperation="destination-over",p.fillRect(0,0,h,l));this._context.drawImage(n,d*h,e*l,h,l)}else this._context.drawImage(this._options.tileSet,m[0],m[1],h,l,d*h,e*l,h,l)}};c.Display.Tile.prototype.computeSize=
function(a,b){return[Math.floor(a/this._options.tileWidth),Math.floor(b/this._options.tileHeight)]};c.Display.Tile.prototype.computeFontSize=function(a,b){return[Math.floor(a/this._options.width),Math.floor(b/this._options.height)]};c.Display.Tile.prototype.eventToPosition=function(a,b){return[Math.floor(a/this._options.tileWidth),Math.floor(b/this._options.tileHeight)]};c.RNG={getSeed:function(){return this._seed},setSeed:function(a){this._seed=a=1>a?1/a:a;this._s0=(a>>>0)*this._frac;a=69069*a+1>>>
0;this._s1=a*this._frac;this._s2=(69069*a+1>>>0)*this._frac;this._c=1;return this},getUniform:function(){var a=2091639*this._s0+this._c*this._frac;this._s0=this._s1;this._s1=this._s2;this._c=a|0;return this._s2=a-this._c},getUniformInt:function(a,b){var d=Math.max(a,b);a=Math.min(a,b);return Math.floor(this.getUniform()*(d-a+1))+a},getNormal:function(a,b){do{var d=2*this.getUniform()-1,e=2*this.getUniform()-1;e=d*d+e*e}while(1<e||0==e);return(a||0)+d*Math.sqrt(-2*Math.log(e)/e)*(b||1)},getPercentage:function(){return 1+
Math.floor(100*this.getUniform())},getWeightedValue:function(a){var b=0,d;for(d in a)b+=a[d];b*=this.getUniform();var e=0;for(d in a)if(e+=a[d],b<e)break;return d},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(a){this._s0=a[0];this._s1=a[1];this._s2=a[2];this._c=a[3];return this},clone:function(){var a=Object.create(this);a.setState(this.getState());return a},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10};c.RNG.setSeed(Date.now());c.StringGenerator=function(a){this._options=
{words:!1,order:3,prior:.001};for(var b in a)this._options[b]=a[b];this._suffix=this._boundary=String.fromCharCode(0);this._prefix=[];for(a=0;a<this._options.order;a++)this._prefix.push(this._boundary);this._priorValues={};this._priorValues[this._boundary]=this._options.prior;this._data={}};c.StringGenerator.prototype.clear=function(){this._data={};this._priorValues={}};c.StringGenerator.prototype.generate=function(){for(var a=[this._sample(this._prefix)];a[a.length-1]!=this._boundary;)a.push(this._sample(a));
return this._join(a.slice(0,-1))};c.StringGenerator.prototype.observe=function(a){a=this._split(a);for(var b=0;b<a.length;b++)this._priorValues[a[b]]=this._options.prior;a=this._prefix.concat(a).concat(this._suffix);for(b=this._options.order;b<a.length;b++)for(var d=a.slice(b-this._options.order,b),e=a[b],f=0;f<d.length;f++){var c=d.slice(f);this._observeEvent(c,e)}};c.StringGenerator.prototype.getStats=function(){var a=[],b=0,d;for(d in this._priorValues)b++;b--;a.push("distinct samples: "+b);var e=
b=0;for(d in this._data){b++;for(var c in this._data[d])e++}a.push("dictionary size (contexts): "+b);a.push("dictionary size (events): "+e);return a.join(", ")};c.StringGenerator.prototype._split=function(a){return a.split(this._options.words?/\s+/:"")};c.StringGenerator.prototype._join=function(a){return a.join(this._options.words?" ":"")};c.StringGenerator.prototype._observeEvent=function(a,b){a=this._join(a);a in this._data||(this._data[a]={});a=this._data[a];b in a||(a[b]=0);a[b]++};c.StringGenerator.prototype._sample=
function(a){a=this._backoff(a);a=this._join(a);a=this._data[a];var b={};if(this._options.prior){for(var d in this._priorValues)b[d]=this._priorValues[d];for(d in a)b[d]+=a[d]}else b=a;return c.RNG.getWeightedValue(b)};c.StringGenerator.prototype._backoff=function(a){for(a.length>this._options.order?a=a.slice(-this._options.order):a.length<this._options.order&&(a=this._prefix.slice(0,this._options.order-a.length).concat(a));!(this._join(a)in this._data)&&0<a.length;)a=a.slice(1);return a};c.EventQueue=
function(){this._time=0;this._events=[];this._eventTimes=[]};c.EventQueue.prototype.getTime=function(){return this._time};c.EventQueue.prototype.clear=function(){this._events=[];this._eventTimes=[];return this};c.EventQueue.prototype.add=function(a,b){for(var d=this._events.length,e=0;e<this._eventTimes.length;e++)if(this._eventTimes[e]>b){d=e;break}this._events.splice(d,0,a);this._eventTimes.splice(d,0,b)};c.EventQueue.prototype.get=function(){if(!this._events.length)return null;var a=this._eventTimes.splice(0,
1)[0];if(0<a){this._time+=a;for(var b=0;b<this._eventTimes.length;b++)this._eventTimes[b]-=a}return this._events.splice(0,1)[0]};c.EventQueue.prototype.getEventTime=function(a){a=this._events.indexOf(a);if(-1!=a)return this._eventTimes[a]};c.EventQueue.prototype.remove=function(a){a=this._events.indexOf(a);if(-1==a)return!1;this._remove(a);return!0};c.EventQueue.prototype._remove=function(a){this._events.splice(a,1);this._eventTimes.splice(a,1)};c.Scheduler=function(){this._queue=new c.EventQueue;
this._repeat=[];this._current=null};c.Scheduler.prototype.getTime=function(){return this._queue.getTime()};c.Scheduler.prototype.add=function(a,b){b&&this._repeat.push(a);return this};c.Scheduler.prototype.getTimeOf=function(a){return this._queue.getEventTime(a)};c.Scheduler.prototype.clear=function(){this._queue.clear();this._repeat=[];this._current=null;return this};c.Scheduler.prototype.remove=function(a){var b=this._queue.remove(a),d=this._repeat.indexOf(a);-1!=d&&this._repeat.splice(d,1);this._current==
a&&(this._current=null);return b};c.Scheduler.prototype.next=function(){return this._current=this._queue.get()};c.Scheduler.Simple=function(){c.Scheduler.call(this)};c.Scheduler.Simple.extend(c.Scheduler);c.Scheduler.Simple.prototype.add=function(a,b){this._queue.add(a,0);return c.Scheduler.prototype.add.call(this,a,b)};c.Scheduler.Simple.prototype.next=function(){this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0);return c.Scheduler.prototype.next.call(this)};
c.Scheduler.Speed=function(){c.Scheduler.call(this)};c.Scheduler.Speed.extend(c.Scheduler);c.Scheduler.Speed.prototype.add=function(a,b,d){this._queue.add(a,void 0!==d?d:1/a.getSpeed());return c.Scheduler.prototype.add.call(this,a,b)};c.Scheduler.Speed.prototype.next=function(){this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed());return c.Scheduler.prototype.next.call(this)};c.Scheduler.Action=function(){c.Scheduler.call(this);this._duration=
this._defaultDuration=1};c.Scheduler.Action.extend(c.Scheduler);c.Scheduler.Action.prototype.add=function(a,b,d){this._queue.add(a,d||this._defaultDuration);return c.Scheduler.prototype.add.call(this,a,b)};c.Scheduler.Action.prototype.clear=function(){this._duration=this._defaultDuration;return c.Scheduler.prototype.clear.call(this)};c.Scheduler.Action.prototype.remove=function(a){a==this._current&&(this._duration=this._defaultDuration);return c.Scheduler.prototype.remove.call(this,a)};c.Scheduler.Action.prototype.next=
function(){this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration);return c.Scheduler.prototype.next.call(this)};c.Scheduler.Action.prototype.setDuration=function(a){this._current&&(this._duration=a);return this};c.Engine=function(a){this._scheduler=a;this._lock=1};c.Engine.prototype.start=function(){return this.unlock()};c.Engine.prototype.lock=function(){this._lock++;return this};c.Engine.prototype.unlock=
function(){if(!this._lock)throw Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var a=this._scheduler.next();if(!a)return this.lock();(a=a.act())&&a.then&&(this.lock(),a.then(this.unlock.bind(this)))}return this};c.Map=function(a,b){this._width=a||c.DEFAULT_WIDTH;this._height=b||c.DEFAULT_HEIGHT};c.Map.prototype.create=function(a){};c.Map.prototype._fillMap=function(a){for(var b=[],d=0;d<this._width;d++){b.push([]);for(var e=0;e<this._height;e++)b[d].push(a)}return b};c.Map.Arena=
function(a,b){c.Map.call(this,a,b)};c.Map.Arena.extend(c.Map);c.Map.Arena.prototype.create=function(a){for(var b=this._width-1,d=this._height-1,e=0;e<=b;e++)for(var c=0;c<=d;c++)a(e,c,e&&c&&e<b&&c<d?0:1);return this};c.Map.DividedMaze=function(a,b){c.Map.call(this,a,b);this._stack=[]};c.Map.DividedMaze.extend(c.Map);c.Map.DividedMaze.prototype.create=function(a){var b=this._width,d=this._height;this._map=[];for(var e=0;e<b;e++){this._map.push([]);for(var c=0;c<d;c++)this._map[e].push(0==e||0==c||
e+1==b||c+1==d?1:0)}this._stack=[[1,1,b-2,d-2]];this._process();for(e=0;e<b;e++)for(c=0;c<d;c++)a(e,c,this._map[e][c]);this._map=null;return this};c.Map.DividedMaze.prototype._process=function(){for(;this._stack.length;){var a=this._stack.shift();this._partitionRoom(a)}};c.Map.DividedMaze.prototype._partitionRoom=function(a){for(var b=[],d=[],e=a[0]+1;e<a[2];e++){var c=this._map[e][a[3]+1];!this._map[e][a[1]-1]||!c||e%2||b.push(e)}for(e=a[1]+1;e<a[3];e++)c=this._map[a[2]+1][e],!this._map[a[0]-1][e]||
!c||e%2||d.push(e);if(b.length&&d.length){b=b.random();d=d.random();this._map[b][d]=1;c=[];var g=[];c.push(g);for(e=a[0];e<b;e++)this._map[e][d]=1,g.push([e,d]);g=[];c.push(g);for(e=b+1;e<=a[2];e++)this._map[e][d]=1,g.push([e,d]);g=[];c.push(g);for(e=a[1];e<d;e++)this._map[b][e]=1,g.push([b,e]);g=[];c.push(g);for(e=d+1;e<=a[3];e++)this._map[b][e]=1,g.push([b,e]);var h=c.random();for(e=0;e<c.length;e++)g=c[e],g!=h&&(g=g.random(),this._map[g[0]][g[1]]=0);this._stack.push([a[0],a[1],b-1,d-1]);this._stack.push([b+
1,a[1],a[2],d-1]);this._stack.push([a[0],d+1,b-1,a[3]]);this._stack.push([b+1,d+1,a[2],a[3]])}};c.Map.IceyMaze=function(a,b,d){c.Map.call(this,a,b);this._regularity=d||0};c.Map.IceyMaze.extend(c.Map);c.Map.IceyMaze.prototype.create=function(a){var b=this._width,d=this._height,e=this._fillMap(1);b-=b%2?1:2;d-=d%2?1:2;var f=0,g=[[0,0],[0,0],[0,0],[0,0]];do{var h=1+2*Math.floor(c.RNG.getUniform()*(b-1)/2);var l=1+2*Math.floor(c.RNG.getUniform()*(d-1)/2);f||(e[h][l]=0);if(!e[h][l]){this._randomize(g);
do{0==Math.floor(c.RNG.getUniform()*(this._regularity+1))&&this._randomize(g);var m=!0;for(var n=0;4>n;n++){var p=h+2*g[n][0];var q=l+2*g[n][1];if(this._isFree(e,p,q,b,d)){e[p][q]=0;e[h+g[n][0]][l+g[n][1]]=0;h=p;l=q;m=!1;f++;break}}}while(!m)}}while(f+1<b*d/4);for(n=0;n<this._width;n++)for(b=0;b<this._height;b++)a(n,b,e[n][b]);this._map=null;return this};c.Map.IceyMaze.prototype._randomize=function(a){for(var b=0;4>b;b++)a[b][0]=0,a[b][1]=0;switch(Math.floor(4*c.RNG.getUniform())){case 0:a[0][0]=
-1;a[1][0]=1;a[2][1]=-1;a[3][1]=1;break;case 1:a[3][0]=-1;a[2][0]=1;a[1][1]=-1;a[0][1]=1;break;case 2:a[2][0]=-1;a[3][0]=1;a[0][1]=-1;a[1][1]=1;break;case 3:a[1][0]=-1,a[0][0]=1,a[3][1]=-1,a[2][1]=1}};c.Map.IceyMaze.prototype._isFree=function(a,b,d,e,c){return 1>b||1>d||b>=e||d>=c?!1:a[b][d]};c.Map.EllerMaze=function(a,b){c.Map.call(this,a,b)};c.Map.EllerMaze.extend(c.Map);c.Map.EllerMaze.prototype.create=function(a){for(var b=this._fillMap(1),d=Math.ceil((this._width-2)/2),e=9/24,f=[],g=[],h=0;h<
d;h++)f.push(h),g.push(h);f.push(d-1);for(var l=1;l+3<this._height;l+=2)for(h=0;h<d;h++){var m=2*h+1,n=l;b[m][n]=0;h!=f[h+1]&&c.RNG.getUniform()>e&&(this._addToList(h,f,g),b[m+1][n]=0);h!=f[h]&&c.RNG.getUniform()>e?this._removeFromList(h,f,g):b[m][n+1]=0}for(h=0;h<d;h++)m=2*h+1,n=l,b[m][n]=0,h!=f[h+1]&&(h==f[h]||c.RNG.getUniform()>e)&&(this._addToList(h,f,g),b[m+1][n]=0),this._removeFromList(h,f,g);for(h=0;h<this._width;h++)for(l=0;l<this._height;l++)a(h,l,b[h][l]);return this};c.Map.EllerMaze.prototype._removeFromList=
function(a,b,d){d[b[a]]=d[a];b[d[a]]=b[a];d[a]=a;b[a]=a};c.Map.EllerMaze.prototype._addToList=function(a,b,d){d[b[a+1]]=d[a];b[d[a]]=b[a+1];d[a]=a+1;b[a+1]=a};c.Map.Cellular=function(a,b,d){c.Map.call(this,a,b);this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8};this.setOptions(d);this._dirs=c.DIRS[this._options.topology];this._map=this._fillMap(0)};c.Map.Cellular.extend(c.Map);c.Map.Cellular.prototype.randomize=function(a){for(var b=0;b<this._width;b++)for(var d=0;d<this._height;d++)this._map[b][d]=
c.RNG.getUniform()<a?1:0;return this};c.Map.Cellular.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b]};c.Map.Cellular.prototype.set=function(a,b,d){this._map[a][b]=d};c.Map.Cellular.prototype.create=function(a){for(var b=this._fillMap(0),d=this._options.born,e=this._options.survive,c=0;c<this._height;c++){var g=1,h=0;6==this._options.topology&&(g=2,h=c%2);for(;h<this._width;h+=g){var l=this._map[h][c],m=this._getNeighbors(h,c);l&&-1!=e.indexOf(m)?b[h][c]=1:l||-1==d.indexOf(m)||
(b[h][c]=1)}}this._map=b;a&&this._serviceCallback(a)};c.Map.Cellular.prototype._serviceCallback=function(a){for(var b=0;b<this._height;b++){var d=1,e=0;6==this._options.topology&&(d=2,e=b%2);for(;e<this._width;e+=d)a(e,b,this._map[e][b])}};c.Map.Cellular.prototype._getNeighbors=function(a,b){for(var d=0,e=0;e<this._dirs.length;e++){var c=this._dirs[e],g=a+c[0];c=b+c[1];0>g||g>=this._width||0>c||c>=this._height||(d+=1==this._map[g][c]?1:0)}return d};c.Map.Cellular.prototype.connect=function(a,b,d){b||
(b=0);var e=[],f={},g=1,h=[0,0];6==this._options.topology&&(g=2,h=[0,1]);for(var l=0;l<this._height;l++)for(var m=h[l%2];m<this._width;m+=g)if(this._freeSpace(m,l,b)){var n=[m,l];f[this._pointKey(n)]=n;e.push([m,l])}n=e[c.RNG.getUniformInt(0,e.length-1)];g=this._pointKey(n);e={};e[g]=n;delete f[g];for(this._findConnected(e,f,[n],!1,b);0<Object.keys(f).length;){n=this._getFromTo(e,f);g=n[0];h=n[1];n={};n[this._pointKey(g)]=g;this._findConnected(n,f,[g],!0,b);(6==this._options.topology?this._tunnelToConnected6:
this._tunnelToConnected).call(this,h,g,e,f,b,d);for(var p in n)g=n[p],this._map[g[0]][g[1]]=b,e[p]=g,delete f[p]}a&&this._serviceCallback(a)};c.Map.Cellular.prototype._getFromTo=function(a,b){for(var d,e,f,g=Object.keys(a),h=Object.keys(b),l=0;5>l&&!(g.length<h.length?(d=g,e=a[d[c.RNG.getUniformInt(0,d.length-1)]],d=this._getClosest(e,b)):(d=h,d=b[d[c.RNG.getUniformInt(0,d.length-1)]],e=this._getClosest(d,a)),f=(d[0]-e[0])*(d[0]-e[0])+(d[1]-e[1])*(d[1]-e[1]),64>f);l++);return[d,e]};c.Map.Cellular.prototype._getClosest=
function(a,b){var d=null,e=null;for(k in b){var c=b[k],g=(c[0]-a[0])*(c[0]-a[0])+(c[1]-a[1])*(c[1]-a[1]);if(null==e||g<e)e=g,d=c}return d};c.Map.Cellular.prototype._findConnected=function(a,b,d,e,c){for(;0<d.length;){var f=d.splice(0,1)[0];f=6==this._options.topology?[[f[0]+2,f[1]],[f[0]+1,f[1]-1],[f[0]-1,f[1]-1],[f[0]-2,f[1]],[f[0]-1,f[1]+1],[f[0]+1,f[1]+1]]:[[f[0]+1,f[1]],[f[0]-1,f[1]],[f[0],f[1]+1],[f[0],f[1]-1]];for(var h=0;h<f.length;h++){var l=this._pointKey(f[h]);null==a[l]&&this._freeSpace(f[h][0],
f[h][1],c)&&(a[l]=f[h],e||delete b[l],d.push(f[h]))}}};c.Map.Cellular.prototype._tunnelToConnected=function(a,b,d,e,c,g){this._pointKey(b);if(b[0]<a[0]){var f=b;var l=a}else f=a,l=b;for(var m=f[0];m<=l[0];m++){this._map[m][f[1]]=c;var n=[m,f[1]],p=this._pointKey(n);d[p]=n;delete e[p]}g&&f[0]<l[0]&&g(f,[l[0],f[1]]);m=l[0];b[1]<a[1]?(f=b,l=a):(f=a,l=b);for(a=f[1];a<l[1];a++)this._map[m][a]=c,n=[m,a],p=this._pointKey(n),d[p]=n,delete e[p];g&&f[1]<l[1]&&g([l[0],f[1]],[l[0],l[1]])};c.Map.Cellular.prototype._tunnelToConnected6=
function(a,b,d,e,c,g){if(b[0]<a[0]){var f=b;var l=a}else f=a,l=b;var m=f[0];for(f=f[1];m!=l[0]||f!=l[1];){var n=2;f<l[1]?(f++,n=1):f>l[1]&&(f--,n=1);m=m<l[0]?m+n:m>l[0]?m-n:l[1]%2?m-n:m+n;this._map[m][f]=c;n=[m,f];var p=this._pointKey(n);d[p]=n;delete e[p]}g&&g(b,a)};c.Map.Cellular.prototype._freeSpace=function(a,b,d){return 0<=a&&a<this._width&&0<=b&&b<this._height&&this._map[a][b]==d};c.Map.Cellular.prototype._pointKey=function(a){return a[0]+"."+a[1]};c.Map.Dungeon=function(a,b){c.Map.call(this,
a,b);this._rooms=[];this._corridors=[]};c.Map.Dungeon.extend(c.Map);c.Map.Dungeon.prototype.getRooms=function(){return this._rooms};c.Map.Dungeon.prototype.getCorridors=function(){return this._corridors};c.Map.Digger=function(a,b,d){c.Map.Dungeon.call(this,a,b);this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1E3};for(var e in d)this._options[e]=d[e];this._features={Room:4,Corridor:4};this._featureAttempts=20;this._walls={};this._digCallback=this._digCallback.bind(this);
this._canBeDugCallback=this._canBeDugCallback.bind(this);this._isWallCallback=this._isWallCallback.bind(this);this._priorityWallCallback=this._priorityWallCallback.bind(this)};c.Map.Digger.extend(c.Map.Dungeon);c.Map.Digger.prototype.create=function(a){this._rooms=[];this._corridors=[];this._map=this._fillMap(1);this._walls={};this._dug=0;var b=(this._width-2)*(this._height-2);this._firstRoom();var d=Date.now();do{if(Date.now()-d>this._options.timeLimit)break;var e=this._findWall();if(!e)break;var c=
e.split(",");e=parseInt(c[0]);c=parseInt(c[1]);var g=this._getDiggingDirection(e,c);if(g){var h=0;do if(h++,this._tryFeature(e,c,g[0],g[1])){this._removeSurroundingWalls(e,c);this._removeSurroundingWalls(e-g[0],c-g[1]);break}while(h<this._featureAttempts);h=0;for(var l in this._walls)1<this._walls[l]&&h++}}while(this._dug/b<this._options.dugPercentage||h);this._addDoors();if(a)for(b=0;b<this._width;b++)for(d=0;d<this._height;d++)a(b,d,this._map[b][d]);this._walls={};this._map=null;return this};c.Map.Digger.prototype._digCallback=
function(a,b,d){0==d||2==d?(this._map[a][b]=0,this._dug++):this._walls[a+","+b]=1};c.Map.Digger.prototype._isWallCallback=function(a,b){return 0>a||0>b||a>=this._width||b>=this._height?!1:1==this._map[a][b]};c.Map.Digger.prototype._canBeDugCallback=function(a,b){return 1>a||1>b||a+1>=this._width||b+1>=this._height?!1:1==this._map[a][b]};c.Map.Digger.prototype._priorityWallCallback=function(a,b){this._walls[a+","+b]=2};c.Map.Digger.prototype._firstRoom=function(){var a=c.Map.Feature.Room.createRandomCenter(Math.floor(this._width/
2),Math.floor(this._height/2),this._options);this._rooms.push(a);a.create(this._digCallback)};c.Map.Digger.prototype._findWall=function(){var a=[],b=[];for(d in this._walls)2==this._walls[d]?b.push(d):a.push(d);a=b.length?b:a;if(!a.length)return null;var d=a.sort().random();delete this._walls[d];return d};c.Map.Digger.prototype._tryFeature=function(a,b,d,e){var f=c.RNG.getWeightedValue(this._features);f=c.Map.Feature[f].createRandomAt(a,b,d,e,this._options);if(!f.isValid(this._isWallCallback,this._canBeDugCallback))return!1;
f.create(this._digCallback);f instanceof c.Map.Feature.Room&&this._rooms.push(f);f instanceof c.Map.Feature.Corridor&&(f.createPriorityWalls(this._priorityWallCallback),this._corridors.push(f));return!0};c.Map.Digger.prototype._removeSurroundingWalls=function(a,b){for(var d=c.DIRS[4],e=0;e<d.length;e++){var f=d[e],g=a+f[0],h=b+f[1];delete this._walls[g+","+h];g=a+2*f[0];h=b+2*f[1];delete this._walls[g+","+h]}};c.Map.Digger.prototype._getDiggingDirection=function(a,b){if(0>=a||0>=b||a>=this._width-
1||b>=this._height-1)return null;for(var d=null,e=c.DIRS[4],f=0;f<e.length;f++){var g=e[f];if(!this._map[a+g[0]][b+g[1]]){if(d)return null;d=g}}return d?[-d[0],-d[1]]:null};c.Map.Digger.prototype._addDoors=function(){for(var a=this._map,b=function(b,d){return 1==a[b][d]},d=0;d<this._rooms.length;d++){var e=this._rooms[d];e.clearDoors();e.addDoors(b)}};c.Map.Uniform=function(a,b,d){c.Map.Dungeon.call(this,a,b);this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1E3};for(var e in d)this._options[e]=
d[e];this._corridorAttempts=this._roomAttempts=20;this._connected=[];this._unconnected=[];this._digCallback=this._digCallback.bind(this);this._canBeDugCallback=this._canBeDugCallback.bind(this);this._isWallCallback=this._isWallCallback.bind(this)};c.Map.Uniform.extend(c.Map.Dungeon);c.Map.Uniform.prototype.create=function(a){for(var b=Date.now();;){if(Date.now()-b>this._options.timeLimit)return null;this._map=this._fillMap(1);this._dug=0;this._rooms=[];this._unconnected=[];this._generateRooms();if(!(2>
this._rooms.length)&&this._generateCorridors())break}if(a)for(b=0;b<this._width;b++)for(var d=0;d<this._height;d++)a(b,d,this._map[b][d]);return this};c.Map.Uniform.prototype._generateRooms=function(){var a=this._width-2,b=this._height-2;do{var d=this._generateRoom();if(this._dug/(a*b)>this._options.roomDugPercentage)break}while(d)};c.Map.Uniform.prototype._generateRoom=function(){for(var a=0;a<this._roomAttempts;){a++;var b=c.Map.Feature.Room.createRandom(this._width,this._height,this._options);
if(b.isValid(this._isWallCallback,this._canBeDugCallback))return b.create(this._digCallback),this._rooms.push(b),b}return null};c.Map.Uniform.prototype._generateCorridors=function(){for(var a=0;a<this._corridorAttempts;){a++;this._corridors=[];this._map=this._fillMap(1);for(var b=0;b<this._rooms.length;b++){var d=this._rooms[b];d.clearDoors();d.create(this._digCallback)}this._unconnected=this._rooms.slice().randomize();this._connected=[];for(this._unconnected.length&&this._connected.push(this._unconnected.pop());;){b=
this._connected.random();b=this._closestRoom(this._unconnected,b);d=this._closestRoom(this._connected,b);if(!this._connectRooms(b,d))break;if(!this._unconnected.length)return!0}}return!1};c.Map.Uniform.prototype._closestRoom=function(a,b){var d=Infinity;b=b.getCenter();for(var e=null,c=0;c<a.length;c++){var g=a[c],h=g.getCenter(),l=h[0]-b[0];h=h[1]-b[1];l=l*l+h*h;l<d&&(d=l,e=g)}return e};c.Map.Uniform.prototype._connectRooms=function(a,b){var d=a.getCenter(),e=b.getCenter(),c=e[0]-d[0];d=e[1]-d[1];
if(Math.abs(c)<Math.abs(d)){d=0<d?2:0;var g=(d+2)%4,h=b.getLeft(),l=b.getRight();c=0}else d=0<c?1:3,g=(d+2)%4,h=b.getTop(),l=b.getBottom(),c=1;d=this._placeInWall(a,d);if(!d)return!1;if(d[c]>=h&&d[c]<=l){var m=d.slice();e=null;switch(g){case 0:e=b.getTop()-1;break;case 1:e=b.getRight()+1;break;case 2:e=b.getBottom()+1;break;case 3:e=b.getLeft()-1}m[(c+1)%2]=e;this._digLine([d,m])}else if(d[c]<h-1||d[c]>l+1){e=d[c]-e[c];switch(g){case 0:case 1:m=0>e?3:1;break;case 2:case 3:m=0>e?1:3}m=this._placeInWall(b,
(g+m)%4);if(!m)return!1;g=[0,0];g[c]=d[c];e=(c+1)%2;g[e]=m[e];this._digLine([d,g,m])}else{e=(c+1)%2;m=this._placeInWall(b,g);if(!m)return!1;g=Math.round((m[e]+d[e])/2);h=[0,0];l=[0,0];h[c]=d[c];h[e]=g;l[c]=m[c];l[e]=g;this._digLine([d,h,l,m])}a.addDoor(d[0],d[1]);b.addDoor(m[0],m[1]);c=this._unconnected.indexOf(a);-1!=c&&(this._unconnected.splice(c,1),this._connected.push(a));c=this._unconnected.indexOf(b);-1!=c&&(this._unconnected.splice(c,1),this._connected.push(b));return!0};c.Map.Uniform.prototype._placeInWall=
function(a,b){var d=[0,0],c=[0,0],f=0;switch(b){case 0:c=[1,0];d=[a.getLeft(),a.getTop()-1];f=a.getRight()-a.getLeft()+1;break;case 1:c=[0,1];d=[a.getRight()+1,a.getTop()];f=a.getBottom()-a.getTop()+1;break;case 2:c=[1,0];d=[a.getLeft(),a.getBottom()+1];f=a.getRight()-a.getLeft()+1;break;case 3:c=[0,1],d=[a.getLeft()-1,a.getTop()],f=a.getBottom()-a.getTop()+1}a=[];b=-2;for(var g=0;g<f;g++){var h=d[0]+g*c[0],l=d[1]+g*c[1];a.push(null);1==this._map[h][l]?b!=g-1&&(a[g]=[h,l]):(b=g)&&(a[g-1]=null)}for(g=
a.length-1;0<=g;g--)a[g]||a.splice(g,1);return a.length?a.random():null};c.Map.Uniform.prototype._digLine=function(a){for(var b=1;b<a.length;b++){var d=a[b-1],e=a[b];d=new c.Map.Feature.Corridor(d[0],d[1],e[0],e[1]);d.create(this._digCallback);this._corridors.push(d)}};c.Map.Uniform.prototype._digCallback=function(a,b,d){this._map[a][b]=d;0==d&&this._dug++};c.Map.Uniform.prototype._isWallCallback=function(a,b){return 0>a||0>b||a>=this._width||b>=this._height?!1:1==this._map[a][b]};c.Map.Uniform.prototype._canBeDugCallback=
function(a,b){return 1>a||1>b||a+1>=this._width||b+1>=this._height?!1:1==this._map[a][b]};c.Map.Rogue=function(a,b,d){c.Map.call(this,a,b);this._options={cellWidth:3,cellHeight:3};for(var e in d)this._options[e]=d[e];this._options.hasOwnProperty("roomWidth")||(this._options.roomWidth=this._calculateRoomSize(this._width,this._options.cellWidth));this._options.hasOwnProperty("roomHeight")||(this._options.roomHeight=this._calculateRoomSize(this._height,this._options.cellHeight))};c.Map.Rogue.extend(c.Map);
c.Map.Rogue.prototype.create=function(a){this.map=this._fillMap(1);this.rooms=[];this.connectedCells=[];this._initRooms();this._connectRooms();this._connectUnconnectedRooms();this._createRandomRoomConnections();this._createRooms();this._createCorridors();if(a)for(var b=0;b<this._width;b++)for(var d=0;d<this._height;d++)a(b,d,this.map[b][d]);return this};c.Map.Rogue.prototype._calculateRoomSize=function(a,b){var d=Math.floor(a/b*.8);a=Math.floor(a/b*.25);2>a&&(a=2);2>d&&(d=2);return[a,d]};c.Map.Rogue.prototype._initRooms=
function(){for(var a=0;a<this._options.cellWidth;a++){this.rooms.push([]);for(var b=0;b<this._options.cellHeight;b++)this.rooms[a].push({x:0,y:0,width:0,height:0,connections:[],cellx:a,celly:b})}};c.Map.Rogue.prototype._connectRooms=function(){var a=c.RNG.getUniformInt(0,this._options.cellWidth-1),b=c.RNG.getUniformInt(0,this._options.cellHeight-1);do{var d=[0,2,4,6];d=d.randomize();do{var e=!1;var f=d.pop();var g=a+c.DIRS[8][f][0];f=b+c.DIRS[8][f][1];if(!(0>g||g>=this._options.cellWidth||0>f||f>=
this._options.cellHeight)){var h=this.rooms[a][b];if(0<h.connections.length&&h.connections[0][0]==g&&h.connections[0][1]==f)break;h=this.rooms[g][f];0==h.connections.length&&(h.connections.push([a,b]),this.connectedCells.push([g,f]),a=g,b=f,e=!0)}}while(0<d.length&&0==e)}while(0<d.length)};c.Map.Rogue.prototype._connectUnconnectedRooms=function(){var a=this._options.cellWidth,b=this._options.cellHeight;this.connectedCells=this.connectedCells.randomize();for(var d,e,f,g=0;g<this._options.cellWidth;g++)for(var h=
0;h<this._options.cellHeight;h++)if(d=this.rooms[g][h],0==d.connections.length){var l=[0,2,4,6];l=l.randomize();f=!1;do{var m=l.pop(),n=g+c.DIRS[8][m][0];m=h+c.DIRS[8][m][1];if(!(0>n||n>=a||0>m||m>=b)){e=this.rooms[n][m];f=!0;if(0==e.connections.length)break;for(n=0;n<e.connections.length;n++)if(e.connections[n][0]==g&&e.connections[n][1]==h){f=!1;break}if(f)break}}while(l.length);f?d.connections.push([e.cellx,e.celly]):console.log("-- Unable to connect room.")}};c.Map.Rogue.prototype._createRandomRoomConnections=
function(a){};c.Map.Rogue.prototype._createRooms=function(){for(var a=this._width,b=this._height,d=this._options.cellWidth,e=this._options.cellHeight,f=Math.floor(this._width/d),g=Math.floor(this._height/e),h,l,m=this._options.roomWidth,n=this._options.roomHeight,p,q,r,t=0;t<d;t++)for(var u=0;u<e;u++){p=f*t;q=g*u;0==p&&(p=1);0==q&&(q=1);h=c.RNG.getUniformInt(m[0],m[1]);l=c.RNG.getUniformInt(n[0],n[1]);if(0<u)for(r=this.rooms[t][u-1];3>q-(r.y+r.height);)q++;if(0<t)for(r=this.rooms[t-1][u];3>p-(r.x+
r.width);)p++;r=Math.round(c.RNG.getUniformInt(0,f-h)/2);for(var v=Math.round(c.RNG.getUniformInt(0,g-l)/2);p+r+h>=a;)r?r--:h--;for(;q+v+l>=b;)v?v--:l--;p+=r;q+=v;this.rooms[t][u].x=p;this.rooms[t][u].y=q;this.rooms[t][u].width=h;this.rooms[t][u].height=l;for(r=p;r<p+h;r++)for(v=q;v<q+l;v++)this.map[r][v]=0}};c.Map.Rogue.prototype._getWallPosition=function(a,b){if(1==b||3==b){var d=c.RNG.getUniformInt(a.x+1,a.x+a.width-2);if(1==b){var e=a.y-2;a=e+1}else e=a.y+a.height+1,a=e-1;this.map[d][a]=0}else if(2==
b||4==b)e=c.RNG.getUniformInt(a.y+1,a.y+a.height-2),2==b?(d=a.x+a.width+1,a=d-1):(d=a.x-2,a=d+1),this.map[a][e]=0;return[d,e]};c.Map.Rogue.prototype._drawCorridor=function(a,b){var d=b[0]-a[0],e=b[1]-a[1];b=a[0];a=a[1];var f=[];var g=Math.abs(d);var h=Math.abs(e);var l=c.RNG.getUniform();var m=1-l;d=0<d?2:6;e=0<e?4:0;g<h?(l=Math.ceil(h*l),f.push([e,l]),f.push([d,g]),l=Math.floor(h*m),f.push([e,l])):(l=Math.ceil(g*l),f.push([d,l]),f.push([e,h]),l=Math.floor(g*m),f.push([d,l]));for(this.map[b][a]=0;0<
f.length;)for(g=f.pop();0<g[1];)b+=c.DIRS[8][g[0]][0],a+=c.DIRS[8][g[0]][1],this.map[b][a]=0,--g[1]};c.Map.Rogue.prototype._createCorridors=function(){for(var a=this._options.cellWidth,b=this._options.cellHeight,d,c,f,g,h=0;h<a;h++)for(var l=0;l<b;l++){d=this.rooms[h][l];for(var m=0;m<d.connections.length;m++)c=d.connections[m],c=this.rooms[c[0]][c[1]],c.cellx>d.cellx?(f=2,g=4):c.cellx<d.cellx?(f=4,g=2):c.celly>d.celly?(f=3,g=1):c.celly<d.celly&&(f=1,g=3),this._drawCorridor(this._getWallPosition(d,
f),this._getWallPosition(c,g))}};c.Map.Feature=function(){};c.Map.Feature.prototype.isValid=function(a){};c.Map.Feature.prototype.create=function(a){};c.Map.Feature.prototype.debug=function(){};c.Map.Feature.createRandomAt=function(a,b,d,c,f){};c.Map.Feature.Room=function(a,b,d,c,f,g){this._x1=a;this._y1=b;this._x2=d;this._y2=c;this._doors={};4<arguments.length&&this.addDoor(f,g)};c.Map.Feature.Room.extend(c.Map.Feature);c.Map.Feature.Room.createRandomAt=function(a,b,d,e,f){var g=f.roomWidth[0],h=
f.roomWidth[1],l=c.RNG.getUniformInt(g,h);g=f.roomHeight[0];h=f.roomHeight[1];f=c.RNG.getUniformInt(g,h);if(1==d)return d=b-Math.floor(c.RNG.getUniform()*f),new this(a+1,d,a+l,d+f-1,a,b);if(-1==d)return d=b-Math.floor(c.RNG.getUniform()*f),new this(a-l,d,a-1,d+f-1,a,b);if(1==e)return d=a-Math.floor(c.RNG.getUniform()*l),new this(d,b+1,d+l-1,b+f,a,b);if(-1==e)return d=a-Math.floor(c.RNG.getUniform()*l),new this(d,b-f,d+l-1,b-1,a,b);throw Error("dx or dy must be 1 or -1");};c.Map.Feature.Room.createRandomCenter=
function(a,b,d){var e=d.roomWidth[0],f=d.roomWidth[1],g=c.RNG.getUniformInt(e,f);e=d.roomHeight[0];f=d.roomHeight[1];d=c.RNG.getUniformInt(e,f);a-=Math.floor(c.RNG.getUniform()*g);b-=Math.floor(c.RNG.getUniform()*d);return new this(a,b,a+g-1,b+d-1)};c.Map.Feature.Room.createRandom=function(a,b,d){var e=d.roomWidth[0],f=d.roomWidth[1],g=c.RNG.getUniformInt(e,f);e=d.roomHeight[0];f=d.roomHeight[1];d=c.RNG.getUniformInt(e,f);a=a-g-1;b=b-d-1;a=1+Math.floor(c.RNG.getUniform()*a);b=1+Math.floor(c.RNG.getUniform()*
b);return new this(a,b,a+g-1,b+d-1)};c.Map.Feature.Room.prototype.addDoor=function(a,b){this._doors[a+","+b]=1;return this};c.Map.Feature.Room.prototype.getDoors=function(a){for(var b in this._doors){var d=b.split(",");a(parseInt(d[0]),parseInt(d[1]))}return this};c.Map.Feature.Room.prototype.clearDoors=function(){this._doors={};return this};c.Map.Feature.Room.prototype.addDoors=function(a){for(var b=this._x1-1,d=this._x2+1,c=this._y1-1,f=this._y2+1,g=b;g<=d;g++)for(var h=c;h<=f;h++)if(g==b||g==d||
h==c||h==f)a(g,h)||this.addDoor(g,h);return this};c.Map.Feature.Room.prototype.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)};c.Map.Feature.Room.prototype.isValid=function(a,b){for(var d=this._x1-1,c=this._x2+1,f=this._y1-1,g=this._y2+1,h=d;h<=c;h++)for(var l=f;l<=g;l++)if(h==d||h==c||l==f||l==g){if(!a(h,l))return!1}else if(!b(h,l))return!1;return!0};c.Map.Feature.Room.prototype.create=function(a){for(var b=this._x1-1,d=this._x2+1,c=this._y1-1,f=this._y2+1,g,h=b;h<=d;h++)for(var l=
c;l<=f;l++)g=h+","+l in this._doors?2:h==b||h==d||l==c||l==f?1:0,a(h,l,g)};c.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]};c.Map.Feature.Room.prototype.getLeft=function(){return this._x1};c.Map.Feature.Room.prototype.getRight=function(){return this._x2};c.Map.Feature.Room.prototype.getTop=function(){return this._y1};c.Map.Feature.Room.prototype.getBottom=function(){return this._y2};c.Map.Feature.Corridor=function(a,b,d,
c){this._startX=a;this._startY=b;this._endX=d;this._endY=c;this._endsWithAWall=!0};c.Map.Feature.Corridor.extend(c.Map.Feature);c.Map.Feature.Corridor.createRandomAt=function(a,b,d,e,f){f=c.RNG.getUniformInt(f.corridorLength[0],f.corridorLength[1]);return new this(a,b,a+d*f,b+e*f)};c.Map.Feature.Corridor.prototype.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)};c.Map.Feature.Corridor.prototype.isValid=function(a,b){var d=this._startX,c=this._startY,f=this._endX-
d,g=this._endY-c,h=1+Math.max(Math.abs(f),Math.abs(g));f&&(f/=Math.abs(f));g&&(g/=Math.abs(g));for(var l=g,m=-f,n=!0,p=0;p<h;p++){var q=d+p*f,r=c+p*g;b(q,r)||(n=!1);a(q+l,r+m)||(n=!1);a(q-l,r-m)||(n=!1);if(!n){h=p;this._endX=q-f;this._endY=r-g;break}}if(0==h||1==h&&a(this._endX+f,this._endY+g))return!1;b=!a(this._endX+f+l,this._endY+g+m);l=!a(this._endX+f-l,this._endY+g-m);this._endsWithAWall=a(this._endX+f,this._endY+g);return(b||l)&&this._endsWithAWall?!1:!0};c.Map.Feature.Corridor.prototype.create=
function(a){var b=this._startX,d=this._startY,c=this._endX-b,f=this._endY-d,g=1+Math.max(Math.abs(c),Math.abs(f));c&&(c/=Math.abs(c));f&&(f/=Math.abs(f));for(var h=0;h<g;h++)a(b+h*c,d+h*f,0);return!0};c.Map.Feature.Corridor.prototype.createPriorityWalls=function(a){if(this._endsWithAWall){var b=this._endX-this._startX,d=this._endY-this._startY;b&&(b/=Math.abs(b));d&&(d/=Math.abs(d));var c=d,f=-b;a(this._endX+b,this._endY+d);a(this._endX+c,this._endY+f);a(this._endX-c,this._endY-f)}};c.Noise=function(){};
c.Noise.prototype.get=function(a,b){};c.Noise.Simplex=function(a){c.Noise.call(this);this._F2=.5*(Math.sqrt(3)-1);this._G2=(3-Math.sqrt(3))/6;this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];var b=[];a=a||256;for(var d=0;d<a;d++)b.push(d);b=b.randomize();this._perms=[];this._indexes=[];for(d=0;d<2*a;d++)this._perms.push(b[d%a]),this._indexes.push(this._perms[d]%this._gradients.length)};c.Noise.Simplex.extend(c.Noise);c.Noise.Simplex.prototype.get=function(a,b){var d=this._perms,
c=this._indexes,f=d.length/2,g=this._G2,h=0,l=0,m=0,n=(a+b)*this._F2,p=Math.floor(a+n);var q=Math.floor(b+n);n=(p+q)*g;a-=p-n;var r=b-(q-n);if(a>r){n=1;var t=0}else n=0,t=1;var u=a-n+g,v=r-t+g;b=a-1+2*g;g=r-1+2*g;p=p.mod(f);f=q.mod(f);var w=.5-a*a-r*r;0<=w&&(w*=w,q=c[p+d[f]],q=this._gradients[q],h=w*w*(q[0]*a+q[1]*r));a=.5-u*u-v*v;0<=a&&(a*=a,q=c[p+n+d[f+t]],q=this._gradients[q],l=a*a*(q[0]*u+q[1]*v));a=.5-b*b-g*g;0<=a&&(a*=a,q=c[p+1+d[f+1]],q=this._gradients[q],m=a*a*(q[0]*b+q[1]*g));return 70*(h+
l+m)};c.FOV=function(a,b){this._lightPasses=a;this._options={topology:8};for(var d in b)this._options[d]=b[d]};c.FOV.prototype.compute=function(a,b,d,c){};c.FOV.prototype._getCircle=function(a,b,d){var e=[];switch(this._options.topology){case 4:var f=1;var g=[0,1];var h=[c.DIRS[8][7],c.DIRS[8][1],c.DIRS[8][3],c.DIRS[8][5]];break;case 6:h=c.DIRS[6];f=1;g=[-1,1];break;case 8:h=c.DIRS[4],f=2,g=[-1,1]}a+=g[0]*d;b+=g[1]*d;for(g=0;g<h.length;g++)for(var l=0;l<d*f;l++)e.push([a,b]),a+=h[g][0],b+=h[g][1];
return e};c.FOV.DiscreteShadowcasting=function(a,b){c.FOV.call(this,a,b)};c.FOV.DiscreteShadowcasting.extend(c.FOV);c.FOV.DiscreteShadowcasting.prototype.compute=function(a,b,d,c){c(a,b,0,1);if(this._lightPasses(a,b))for(var e=[],g,h,l,m,n,p=1;p<=d;p++)for(var q=this._getCircle(a,b,p),r=360/q.length,t=0;t<q.length;t++)if(l=q[t][0],m=q[t][1],g=r*(t-.5),h=g+r,n=!this._lightPasses(l,m),this._visibleCoords(Math.floor(g),Math.ceil(h),n,e)&&c(l,m,p,1),2==e.length&&0==e[0]&&360==e[1])return};c.FOV.DiscreteShadowcasting.prototype._visibleCoords=
function(a,b,d,c){if(0>a)return b=this._visibleCoords(0,b,d,c),a=this._visibleCoords(360+a,360,d,c),b||a;for(var e=0;e<c.length&&c[e]<a;)e++;if(e==c.length)return d&&c.push(a,b),!0;var g=0;if(e%2){for(;e<c.length&&c[e]<b;)e++,g++;if(0==g)return!1;d&&(g%2?c.splice(e-g,g,b):c.splice(e-g,g))}else{for(;e<c.length&&c[e]<b;)e++,g++;if(a==c[e-g]&&1==g)return!1;d&&(g%2?c.splice(e-g,g,a):c.splice(e-g,g,a,b))}return!0};c.FOV.PreciseShadowcasting=function(a,b){c.FOV.call(this,a,b)};c.FOV.PreciseShadowcasting.extend(c.FOV);
c.FOV.PreciseShadowcasting.prototype.compute=function(a,b,d,c){c(a,b,0,1);if(this._lightPasses(a,b))for(var e=[],g,h,l,m,n,p=1;p<=d;p++)for(var q=this._getCircle(a,b,p),r=q.length,t=0;t<r;t++)if(g=q[t][0],h=q[t][1],m=[t?2*t-1:2*r-1,2*r],n=[2*t+1,2*r],l=!this._lightPasses(g,h),(l=this._checkVisibility(m,n,l,e))&&c(g,h,p,l),2==e.length&&0==e[0][0]&&e[1][0]==e[1][1])return};c.FOV.PreciseShadowcasting.prototype._checkVisibility=function(a,b,d,c){if(a[0]>b[0])return a=this._checkVisibility(a,[a[1],a[1]],
d,c),b=this._checkVisibility([0,1],b,d,c),(a+b)/2;for(var e=0,g=!1;e<c.length;){var h=c[e];h=h[0]*a[1]-a[0]*h[1];if(0<=h){0!=h||e%2||(g=!0);break}e++}for(var l=c.length,m=!1;l--;)if(h=c[l],h=b[0]*h[1]-h[0]*b[1],0<=h){0==h&&l%2&&(m=!0);break}h=!0;e==l&&(g||m)?h=!1:g&&m&&e+1==l&&l%2?h=!1:e>l&&e%2&&(h=!1);if(!h)return 0;g=l-e+1;if(g%2)e%2?(l=c[e],l=(b[0]*l[1]-l[0]*b[1])/(l[1]*b[1]),d&&c.splice(e,g,b)):(l=c[l],l=(l[0]*a[1]-a[0]*l[1])/(a[1]*l[1]),d&&c.splice(e,g,a));else if(e%2)m=c[e],l=c[l],l=(l[0]*m[1]-
m[0]*l[1])/(m[1]*l[1]),d&&c.splice(e,g);else return d&&c.splice(e,g,a,b),1;return l/((b[0]*a[1]-a[0]*b[1])/(a[1]*b[1]))};c.FOV.RecursiveShadowcasting=function(a,b){c.FOV.call(this,a,b)};c.FOV.RecursiveShadowcasting.extend(c.FOV);c.FOV.RecursiveShadowcasting.OCTANTS=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];c.FOV.RecursiveShadowcasting.prototype.compute=function(a,b,d,e){e(a,b,0,1);for(var f=0;f<c.FOV.RecursiveShadowcasting.OCTANTS.length;f++)this._renderOctant(a,
b,c.FOV.RecursiveShadowcasting.OCTANTS[f],d,e)};c.FOV.RecursiveShadowcasting.prototype.compute180=function(a,b,d,e,f){f(a,b,0,1);var g=(e-1+8)%8,h=(e+1+8)%8;this._renderOctant(a,b,c.FOV.RecursiveShadowcasting.OCTANTS[(e-2+8)%8],d,f);this._renderOctant(a,b,c.FOV.RecursiveShadowcasting.OCTANTS[g],d,f);this._renderOctant(a,b,c.FOV.RecursiveShadowcasting.OCTANTS[e],d,f);this._renderOctant(a,b,c.FOV.RecursiveShadowcasting.OCTANTS[h],d,f)};c.FOV.RecursiveShadowcasting.prototype.compute90=function(a,b,d,
e,f){f(a,b,0,1);var g=(e-1+8)%8;this._renderOctant(a,b,c.FOV.RecursiveShadowcasting.OCTANTS[e],d,f);this._renderOctant(a,b,c.FOV.RecursiveShadowcasting.OCTANTS[g],d,f)};c.FOV.RecursiveShadowcasting.prototype._renderOctant=function(a,b,d,c,f){this._castVisibility(a,b,1,1,0,c+1,d[0],d[1],d[2],d[3],f)};c.FOV.RecursiveShadowcasting.prototype._castVisibility=function(a,b,d,c,f,g,h,l,m,n,p){if(!(c<f))for(;d<=g;d++){for(var e=-d-1,r=-d,t=!1,u=0;0>=e;){e+=1;var v=a+e*h+r*l,w=b+e*m+r*n,y=(e-.5)/(r+.5),x=(e+
.5)/(r-.5);if(!(x>c)){if(y<f)break;e*e+r*r<g*g&&p(v,w,d,1);t?this._lightPasses(v,w)?(t=!1,c=u):u=x:!this._lightPasses(v,w)&&d<g&&(t=!0,this._castVisibility(a,b,d+1,c,y,g,h,l,m,n,p),u=x)}}if(t)break}};c.Color={fromString:function(a){var b;if(a in this._cache)var d=this._cache[a];else{if("#"==a.charAt(0))if(d=a.match(/[0-9a-f]/gi).map(function(a){return parseInt(a,16)}),3==d.length)d=d.map(function(a){return 17*a});else for(b=0;3>b;b++)d[b+1]+=16*d[b],d.splice(b,1);else d=(b=a.match(/rgb\(([0-9, ]+)\)/i))?
b[1].split(/\s*,\s*/).map(function(a){return parseInt(a)}):[0,0,0];this._cache[a]=d}return d.slice()},add:function(a,b){for(var d=a.slice(),c=0;3>c;c++)for(var f=1;f<arguments.length;f++)d[c]+=arguments[f][c];return d},add_:function(a,b){for(var d=0;3>d;d++)for(var c=1;c<arguments.length;c++)a[d]+=arguments[c][d];return a},multiply:function(a,b){for(var d=a.slice(),c=0;3>c;c++){for(var f=1;f<arguments.length;f++)d[c]*=arguments[f][c]/255;d[c]=Math.round(d[c])}return d},multiply_:function(a,b){for(var c=
0;3>c;c++){for(var e=1;e<arguments.length;e++)a[c]*=arguments[e][c]/255;a[c]=Math.round(a[c])}return a},interpolate:function(a,b,c){3>arguments.length&&(c=.5);for(var d=a.slice(),f=0;3>f;f++)d[f]=Math.round(d[f]+c*(b[f]-a[f]));return d},interpolateHSL:function(a,b,c){3>arguments.length&&(c=.5);for(var d=this.rgb2hsl(a),f=this.rgb2hsl(b),g=0;3>g;g++)d[g]+=c*(f[g]-d[g]);return this.hsl2rgb(d)},randomize:function(a,b){b instanceof Array||(b=Math.round(c.RNG.getNormal(0,b)));a=a.slice();for(var d=0;3>
d;d++)a[d]+=b instanceof Array?Math.round(c.RNG.getNormal(0,b[d])):b;return a},rgb2hsl:function(a){var b=a[0]/255,c=a[1]/255;a=a[2]/255;var e=Math.max(b,c,a),f=Math.min(b,c,a),g=(e+f)/2;if(e==f)var h=f=0;else{var l=e-f;f=.5<g?l/(2-e-f):l/(e+f);switch(e){case b:h=(c-a)/l+(c<a?6:0);break;case c:h=(a-b)/l+2;break;case a:h=(b-c)/l+4}h/=6}return[h,f,g]},hsl2rgb:function(a){var b=a[2];if(0==a[1])return b=Math.round(255*b),[b,b,b];var c=function(a,b,c){0>c&&(c+=1);1<c&&--c;return c<1/6?a+6*(b-a)*c:.5>c?
b:c<2/3?a+(b-a)*(2/3-c)*6:a},e=a[1];e=.5>b?b*(1+e):b+e-b*e;var f=2*b-e;b=c(f,e,a[0]+1/3);var g=c(f,e,a[0]);a=c(f,e,a[0]-1/3);return[Math.round(255*b),Math.round(255*g),Math.round(255*a)]},toRGB:function(a){return"rgb("+this._clamp(a[0])+","+this._clamp(a[1])+","+this._clamp(a[2])+")"},toHex:function(a){for(var b=[],c=0;3>c;c++)b.push(this._clamp(a[c]).toString(16).lpad("0",2));return"#"+b.join("")},_clamp:function(a){return 0>a?0:255<a?255:a},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],
mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],
steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],
maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,
216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,
165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,
235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,
235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}};c.Lighting=function(a,b){this._reflectivityCallback=a;this._options={passes:1,emissionThreshold:100,range:10};this._fov=null;this._lights={};this._reflectivityCache={};this._fovCache={};this.setOptions(b)};c.Lighting.prototype.setOptions=
function(a){for(var b in a)this._options[b]=a[b];a&&a.range&&this.reset();return this};c.Lighting.prototype.setFOV=function(a){this._fov=a;this._fovCache={};return this};c.Lighting.prototype.setLight=function(a,b,d){a=a+","+b;d?this._lights[a]="string"==typeof d?c.Color.fromString(d):d:delete this._lights[a];return this};c.Lighting.prototype.clearLights=function(){this._lights={}};c.Lighting.prototype.reset=function(){this._reflectivityCache={};this._fovCache={};return this};c.Lighting.prototype.compute=
function(a){var b={},d={},e={},f;for(f in this._lights){var g=this._lights[f];d[f]=[0,0,0];c.Color.add_(d[f],g)}for(f=0;f<this._options.passes;f++)this._emitLight(d,e,b),f+1!=this._options.passes&&(d=this._computeEmitters(e,b));for(var h in e)d=h.split(","),b=parseInt(d[0]),d=parseInt(d[1]),a(b,d,e[h]);return this};c.Lighting.prototype._emitLight=function(a,b,c){for(var d in a){var f=d.split(","),g=parseInt(f[0]);f=parseInt(f[1]);this._emitLightFromCell(g,f,a[d],b);c[d]=1}return this};c.Lighting.prototype._computeEmitters=
function(a,b){var c={},e;for(e in a)if(!(e in b)){var f=a[e];if(e in this._reflectivityCache)var g=this._reflectivityCache[e];else{var h=e.split(",");g=parseInt(h[0]);h=parseInt(h[1]);g=this._reflectivityCallback(g,h);this._reflectivityCache[e]=g}if(0!=g){h=[];for(var l=0,m=0;3>m;m++){var n=Math.round(f[m]*g);h[m]=n;l+=n}l>this._options.emissionThreshold&&(c[e]=h)}}return c};c.Lighting.prototype._emitLightFromCell=function(a,b,c,e){var d=a+","+b;a=d in this._fovCache?this._fovCache[d]:this._updateFOV(a,
b);for(var g in a){b=a[g];g in e?d=e[g]:(d=[0,0,0],e[g]=d);for(var h=0;3>h;h++)d[h]+=Math.round(c[h]*b)}return this};c.Lighting.prototype._updateFOV=function(a,b){var c={};this._fovCache[a+","+b]=c;var e=this._options.range;this._fov.compute(a,b,e,function(a,b,d,l){d=l*(1-d/e);0!=d&&(c[a+","+b]=d)}.bind(this));return c};c.Path=function(a,b,d,e){this._toX=a;this._toY=b;this._fromY=this._fromX=null;this._passableCallback=d;this._options={topology:8};for(var f in e)this._options[f]=e[f];this._dirs=c.DIRS[this._options.topology];
8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])};c.Path.prototype.compute=function(a,b,c){};c.Path.prototype._getNeighbors=function(a,b){for(var c=[],e=0;e<this._dirs.length;e++){var f=this._dirs[e],g=a+f[0];f=b+f[1];this._passableCallback(g,f)&&c.push([g,f])}return c};c.Path.Dijkstra=function(a,b,d,e){c.Path.call(this,a,b,d,e);this._computed={};this._todo=[];this._add(a,b,null)};c.Path.Dijkstra.extend(c.Path);
c.Path.Dijkstra.prototype.compute=function(a,b,c){var d=a+","+b;d in this._computed||this._compute(a,b);if(d in this._computed)for(a=this._computed[d];a;)c(a.x,a.y),a=a.prev};c.Path.Dijkstra.prototype._compute=function(a,b){for(;this._todo.length;){var c=this._todo.shift();if(c.x==a&&c.y==b)break;for(var e=this._getNeighbors(c.x,c.y),f=0;f<e.length;f++){var g=e[f],h=g[0];g=g[1];h+","+g in this._computed||this._add(h,g,c)}}};c.Path.Dijkstra.prototype._add=function(a,b,c){c={x:a,y:b,prev:c};this._computed[a+
","+b]=c;this._todo.push(c)};c.Path.AStar=function(a,b,d,e){c.Path.call(this,a,b,d,e);this._todo=[];this._done={};this._fromY=this._fromX=null};c.Path.AStar.extend(c.Path);c.Path.AStar.prototype.compute=function(a,b,c){this._todo=[];this._done={};this._fromX=a;this._fromY=b;for(this._add(this._toX,this._toY,null);this._todo.length;){var d=this._todo.shift(),f=d.x+","+d.y;if(!(f in this._done)){this._done[f]=d;if(d.x==a&&d.y==b)break;for(var g=this._getNeighbors(d.x,d.y),h=0;h<g.length;h++){f=g[h];
var l=f[0],m=f[1];f=l+","+m;f in this._done||this._add(l,m,d)}}}if(d=this._done[a+","+b])for(;d;)c(d.x,d.y),d=d.prev};c.Path.AStar.prototype._add=function(a,b,c){var d=this._distance(a,b);a={x:a,y:b,prev:c,g:c?c.g+1:0,h:d};b=a.g+a.h;for(c=0;c<this._todo.length;c++){var f=this._todo[c],g=f.g+f.h;if(b<g||b==g&&d<f.h){this._todo.splice(c,0,a);return}}this._todo.push(a)};c.Path.AStar.prototype._distance=function(a,b){switch(this._options.topology){case 4:return Math.abs(a-this._fromX)+Math.abs(b-this._fromY);
case 6:return b=Math.abs(b-this._fromY),b+Math.max(0,(Math.abs(a-this._fromX)-b)/2);case 8:return Math.max(Math.abs(a-this._fromX),Math.abs(b-this._fromY))}throw Error("Illegal topology");};return c});
